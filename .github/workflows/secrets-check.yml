name: Secrets Check

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    name: Check for exposed secrets

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fail if secrets.h files are committed
        run: |
          SECRETS_FILES=$(git ls-files '**/secrets.h' 'include/secrets.h' || true)
          if [ -n "$SECRETS_FILES" ]; then
            echo "❌ secrets.h files are tracked in git:"
            echo "$SECRETS_FILES"
            echo "Remove them before pushing (they should be gitignored)."
            exit 1
          fi
          echo "✅ No secrets.h files tracked"

      - name: Fail if .env or key files are committed
        run: |
          # Check for .env files (but allow .env.example which is a public template)
          FORBIDDEN_FILES=$(git ls-files '.env' '.env.local' '.env.prod' '.env.staging' '*.pem' '*.key' '*.crt' '*.pfx' '*.p12' || true)
          if [ -n "$FORBIDDEN_FILES" ]; then
            echo "❌ Forbidden files are tracked in git:"
            echo "$FORBIDDEN_FILES"
            echo "Remove them before pushing (they should be gitignored)."
            exit 1
          fi
          
          # Verify .env.example is tracked (public template) and .env is not
          if ! git ls-files '.env.example' >/dev/null 2>&1; then
            echo "⚠️  .env.example not found (should be public template)"
          else
            echo "✅ .env.example template found (public)"
          fi
          
          if git ls-files '.env' >/dev/null 2>&1; then
            echo "❌ .env is tracked in git (should be gitignored)"
            exit 1
          else
            echo "✅ No .env or key/cert files tracked"
          fi

      - name: Verify .gitignore protects secrets
        run: |
          if [ -f .gitignore ]; then
            if grep -qE "(^|/)secrets\.h" .gitignore; then
              echo "✅ .gitignore includes secrets patterns"
            else
              echo "❌ .gitignore missing secrets ignore rules"
              exit 1
            fi
          fi

      - name: Validate secrets template consistency
        run: |
          echo "Checking that example secrets templates exist..."
          templates=(
            "temperature-sensor/include/secrets.h.example"
            "surveillance/include/secrets.h.example"
            "solar-monitor/include/secrets.h.example"
            "surveillance-arduino/ESP32CAM_Surveillance/secrets.h.example"
          )
          missing=0
          for t in "${templates[@]}"; do
            if [ ! -f "$t" ]; then
              echo "⚠️  Missing secrets template: $t (optional)"
            else
              echo "✅ Found secrets template: $t"
            fi
          done

      - name: Scan repository with gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          config-path: .gitleaks.toml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
